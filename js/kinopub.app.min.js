function isInt(e){return!isNaN(e)&&function(e){return(0|e)===e}(parseFloat(e))}function unix2date(e){var t=new Date(1e3*e),i=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],o=t.getFullYear(),a=i[t.getMonth()],n=t.getDate(),r=t.getHours(),d=t.getMinutes(),s=t.getSeconds(),c=n+" "+a+" "+o+" "+r+":"+d+":"+s;return c}function lang(e){return kp.lang.string(e)}var kp={dev:!0,version:.1,_init:function(){kp.modules._init()}};kp.boot={_init:function(){kp.data.storage.device.name||kp.data.store("device",{name:lang("device_default_name")}),kp.auth.isAuthorized()&&kp.auth.checkAccessToken()?(kp.api.notify(),kp.modules.transferControl("boot",!1),kp.ui.deviceActivated()):kp.ui.deviceActivation(),console.log(kp.data.storage)}},jQuery(document).ready(function(){kp._init()}),kp.lang={locale:"ru",string:function(e){return"undefined"==typeof kp.lang[kp.lang.locale]?(kp.log.add("Lang > String > Locale "+kp.lang.locale+" не найдена"),"!"+e):"undefined"==typeof kp.lang[kp.lang.locale][e]?(kp.log.add("Lang > String > Определение "+e+" не найдено в локали "+kp.lang.locale),"?"+e):kp.lang[kp.lang.locale][e]}},kp.log={data:{},storage:[],date:!1,add:function(e){kp.log.date=new Date;var t=kp.log.date.getHours()+":"+kp.log.date.getHours()+":"+kp.log.date.getSeconds()+"."+kp.log.date.getMilliseconds();kp.log.data[t]=e,kp.log.storage.push(t+" > "+e),kp.dev&&console.log(t+" > "+e)}},kp.data={boot:{device:["name","code","expires_in","expiry_interval","interval","user_code","verification_uri"],token:["access_token","expires_in","expiry_interval","refresh_token"],user:["profile_avatar","profile_name","reg_date","reg_unix","subscription_active","subscription_days","subscription_end_unix","subscription_end_date","username"]},storage:{},_init:function(){for(type in this.boot){var e=this.boot[type];this.restore(type,e)}},restore:function(e,t,o){"undefined"==typeof o&&(o="kp_"),"undefined"==typeof kp.data.storage[e]&&(kp.data.storage[e]={});for(i in t){var a=t[i];"undefined"==typeof kp.data.storage[e][a]&&(kp.data.storage[e][a]=null),""!=Cookies.get(o+e+"_"+a)&&(value=Cookies.get(o+e+"_"+a)),null==value||0==value?kp.log.add("Data > Restore > Игнорируем значение ["+e+"/"+a+"]"):(kp.log.add("Data > Restore > ["+e+"/"+a+"] => "+value),kp.data.storage[e][a]=value)}},store:function(e,t,i){"undefined"==typeof i&&(i="kp_");for(name in t){var o=t[name];Cookies.set(i+e+"_"+name,o),kp.data.storage[e][name]=o}},remove:function(e,t,o){"undefined"==typeof o&&(o="kp_");for(i in t){var a=t[i];Cookies.remove(o+e+"_"+a),kp.data.storage[e][a]=null}}},kp.device={width:!1,height:!1,_init:function(){this.width=this.getWidth(),this.height=this.getHeight()},getWidth:function(){return jQuery(document).width()},getHeight:function(){return jQuery(document).height()},widthPercent:function(e){return Math.round(kp.tv.width*(.01*e))},heightPercent:function(e){return Math.round(kp.tv.height*(.01*e))},keys:{N1:49,N2:50,N3:51,N4:52,N5:53,N6:54,N7:55,N8:56,N9:57,N0:48,PRECH:10190,VOL_UP:448,VOL_DOWN:447,MUTE:449,CH_UP:427,CH_DOWN:428,TOOLS:10135,ENTER:13,RETURN:10009,INFO:457,EXIT:10182,UP:38,DOWN:40,LEFT:37,RIGHT:39,RED:403,GREEN:404,YELLOW:405,BLUE:406,RW:412,PAUSE:19,FF:417,REC:416,PLAY:415,STOP:413,PLAYPAUSE:10252},defaultControls:function(){},keyHandlers:{},eventHandled:{},registerKey:function(e,t){if(jQuery.isArray(e))for(i in e){var o=e[i];this.registerKey(o,t)}else{if(!isInt(e)&&"undefined"==typeof this.keys[e])return void kp.log.add("Device > registerKey > Код не найден ["+e+"]");isInt(e)||(e=this.keys[e]),this.keyHandlers[e]=t}},registerEvent:function(e,t,i){var o=this;"undefined"==typeof o.eventHandled[e]&&(o.eventHandled[e]={}),o.eventHandled[e][t]=i,jQuery(document).on(t,e,o.eventHandled[e][t])},setListeners:function(){jQuery(document).on("keyup",function(e){"undefined"!=typeof kp.device.keyHandlers[e.which]&&(kp.log.add("Device > Кнопка #"+e.which),kp.device.keyHandlers[e.which]())})}},kp.api={auth:{host:"https://api.service-kp.com/oauth2/device",refreshHost:"https://api.service-kp.com/oauth2/token",client:{interval:!1,id:"xbmc",secret:"cgg3gtifu46urtfp2zp1nqtba0k2ezxh"}},apiHostUrl:"https://api.service-kp.com/v1/",refreshTokenUrl:"https://api.service-kp.com/oauth2/token",getDeviceCode:function(){var e=this;jQuery.ajax({method:"POST",url:e.auth.host,data:{grant_type:"device_code",client_id:e.auth.client.id,client_secret:e.auth.client.secret}}).done(function(e){kp.log.add("Api > getDeviceCode > Код устройства получен ("+e.code+")"),e.expiry_interval=e.expires_in,e.expires_in=jQuery.now()/1e3+e.expires_in,kp.data.store("device",e),kp.auth.showDeviceCode()}).fail(function(e,t,i){kp.log.add("Api > getDeviceCode > Ошибочка! "+t)})},checkDeviceCode:function(){var e=this;jQuery.ajax({method:"POST",url:e.auth.host,data:{grant_type:"device_token",client_id:e.auth.client.id,client_secret:e.auth.client.secret,code:kp.data.storage.device.code}}).done(function(e){e.expiry_interval=e.expires_in,e.expires_in=jQuery.now()/1e3+e.expires_in,kp.data.store("token",e),kp.log.add("Auth > deviceCodeCheck > Успешно получили access_token, подметаем половичок"),kp.auth.cleanUpAfterGettingDeviceCode()}).fail(function(e,t,i){"authorization_pending"!=e.responseJSON.error&&(kp.log.add(e.responseJSON.error),kp.log.add(e.responseJSON.error_description))})},notify:function(){jQuery.ajax({method:"POST",url:kp.api.apiHostUrl+"device/notify?access_token="+kp.data.storage.token.access_token,data:{title:void 0===window.tizen?lang("device_default_webapp_name")+" @ "+window.location:kp.data.storage.device.name,hardware:void 0===window.tizen?lang("device_default_webapp_detailed_name")+" v. "+kp.version:"OS v."+webapis.tvinfo.getVersion(),software:void 0===window.tizen?lang("device_default_name"):"KinoPub v."+tizen.application.getAppInfo().version}}).done(function(e){}).fail(function(e,t,i){401!=e.responseJSON.status?(kp.log.add(e.responseJSON.error),kp.log.add(e.responseJSON.error_description)):kp.api.updateAccessToken()})},updateAccessToken:function(){kp.log.add("API > updateAccessToken > Запрашиваем новый access token"),jQuery.ajax({method:"POST",url:kp.api.refreshTokenUrl,data:{grant_type:"refresh_token",client_id:kp.api.auth.client.id,client_secret:kp.api.auth.client.secret,refresh_token:kp.data.storage.token.refresh_token}}).done(function(e){kp.log.add("API > updateAccessToken > Access_token обновлен"),e.expiry_interval=e.expires_in,e.expires_in=jQuery.now()+e.expires_in,kp.data.store("token",e)}).fail(function(e,t,i){401!=e.responseJSON.status&&(kp.log.add("API > updateAccessToken > Ошибочка! "+t),kp.log.add(e.responseJSON.error),kp.log.add(e.responseJSON.error_description)),kp.data.remove("token",kp.data.boot.token),kp.ui.deviceActivation()})},getUser:function(){kp.log.add("API > getUser > Получаем данные пользователя"),jQuery.ajax({method:"GET",url:kp.api.apiHostUrl+"user?access_token="+kp.data.storage.token.access_token}).done(function(e){return 200!=e.status?void kp.log.add("API > getUser > Status Error "+e.status):(e=e.user,void kp.data.store("user",{profile_avatar:e.profile.avatar,profile_name:e.profile.name,reg_date:unix2date(e.reg_date),reg_unix:e.reg_date,subscription_active:e.subscription.active,subscription_days:e.subscription.days,subscription_end_date:unix2date(e.subscription.end_time),subscription_end_unix:e.subscription.end_time,username:e.username}))}).fail(function(e,t,i){kp.log.add("API > updateAccessToken > Ошибочка! "+t)})}},kp.user={_init:function(){},getUser:function(){kp.api.getUser()}},kp.ui={_init:function(){this._welcome()},_welcome:function(){var e=this;e._reset(),jQuery("body").addClass("kp-welcome").html('<div class="kp-logo"><h2>kino<span>pub</span></h2></div>'),jQuery(".kp-logo").animate({opacity:1},150).promise().then(function(){kp.auth.checkAccessToken()||jQuery(".kp-logo").animate({marginTop:"-10%"},100).promise().then(function(){jQuery('<div class="kp-status"></div>').insertAfter(".kp-logo"),e.setLoader(jQuery(".kp-status"))})})},_reset:function(){jQuery("body").html("")},setLoader:function(e){e.html('<i class="kp-loader fa fa-beer faa-wrench animated kp-loader" aria-hidden="true"></i>')},removeLoader:function(e){e.remove()},removeLoaders:function(){var e=this;jQuery(".kp-loader").each(function(t,i){e.removeLoader(jQuery(i))})},deviceActivation:function(){return kp.log.add("UI > Интерфейс активации"),jQuery("#kp-device-activation").length?!1:(this.removeLoaders(),kp.modules.transferControl("ui","activation"),jQuery("body").addClass("kp-blurred"),jQuery("body").append('<div id="kp-device-activation"><div class="kp-device-activation-container"><h3>'+lang("device_activation_header")+'</h3><div class="kp-device-activation-code"></div></div></div>'),jQuery("#kp-device-activation").css({width:kp.device.width+"px",height:kp.device.height+"px"}),this.setLoader(jQuery("#kp-device-activation .kp-device-activation-code")),void kp.auth.getDeviceCode())},deviceActivated:function(){kp.log.add("UI > Скрываем интерфейс активации"),jQuery("body").removeClass("kp-blurred"),jQuery("#kp-device-activation").remove(),1==jQuery("body").hasClass("kp-welcome")&&jQuery(".kp-welcome .kp-logo").animate({marginTop:"0%"},1e3).promise().then(function(){jQuery(".kp-logo").animate({opacity:0}).promise().then(function(){kp.user.getUser(),jQuery(".kp-logo").remove(),jQuery("body").animate({backgroundColor:"#2f373e"},700).promise().then(function(){jQuery("body").removeClass("kp-welcome"),jQuery(".kp-logo, .kp-status").remove()})})})},onGetControl:function(e){switch(e){case"activation":kp.device.registerKey(["ENTER"],function(){kp.api.getDeviceCode()}),kp.device.registerEvent("#kp-device-activation .kp-device-activation-code h1","dblclick",function(){kp.api.getDeviceCode()}),kp.device.registerEvent("#kp-device-activation .kp-device-activation-code strong","click",function(e){jQuery("body").append('<form class="kp-device-activation-tmp-form" action="'+jQuery(e.target).text()+'" target="_blank"></form>'),jQuery("form.kp-device-activation-tmp-form").submit().remove()});break;default:kp.log.add("UI > onGetControl > Неизвестный тип ["+e+"]")}}},kp.auth={isAuthorized:function(){return this.hasAccessToken()},getDeviceCode:function(){this.hasDeviceCode()?(kp.log.add("Auth > getDeviceCode > Device код уже есть"),this.showDeviceCode()):(kp.log.add("Auth > getDeviceCode > Получаем новый device код"),kp.api.getDeviceCode())},showDeviceCode:function(){var e=kp.data.storage.device;jQuery("#kp-device-activation .kp-device-activation-code").html("<h1>"+e.user_code+'</h1><div class="kp-device-activation-bar"></div><span>'+lang("device_activation_description")+"<strong>"+e.verification_uri+"</strong></span>"),kp.log.add("Auth > showDeviceCode > Отобразили код, запускаем таймеры"),this.deviceCodeBar(),this.deviceCodeCheck()},deviceCodeCheck:function(){return("undefined"==typeof kp.data.storage.device.intervalCodeChecks||0==kp.data.storage.device.intervalCodeChecks)&&(kp.data.storage.device.intervalCodeChecks=setInterval("kp.auth.deviceCodeCheck();",1e3*kp.data.storage.device.interval)),0==this.hasDeviceCode()?(kp.log.add("Auth > deviceCodeCheck > Код протух, пора брать новый"),this.getDeviceCode(),!1):void kp.api.checkDeviceCode()},cleanUpAfterGettingDeviceCode:function(){kp.log.add("Auth > CleanUp > Удаляем временные данные"),clearInterval(kp.data.storage.device.intervalCodeChecks),clearInterval(kp.data.storage.device.intervalProgressBar);var e=[];for(i in kp.data.storage.device){kp.data.storage.device[i];"name"!=i&&e.push(i)}kp.data.remove("device",e),kp.ui.deviceActivated(),kp.api.notify()},deviceCodeBar:function(){("undefined"==typeof kp.data.storage.device.intervalProgressBar||0==kp.data.storage.device.intervalProgressBar)&&(kp.data.storage.device.intervalProgressBar=setInterval("kp.auth.deviceCodeBar();",300)),jQuery("#kp-device-activation .kp-device-activation-code .kp-device-activation-bar .progress-bar").length||jQuery("#kp-device-activation .kp-device-activation-code .kp-device-activation-bar").html('<div class="progress"><div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuenow="" aria-valuemin="0" aria-valuemax=""></div></div>');var e=jQuery("#kp-device-activation .kp-device-activation-code .kp-device-activation-bar .progress-bar"),t=(this.deviceCodeExpiresIn()/kp.data.storage.device.expiry_interval*100).toFixed(2);e.css({width:t+"%"}),50>t&&e.removeClass("progress-bar-success progress-bar-danger").addClass("progress-bar-warning"),10>t&&e.removeClass("progress-bar-success progress-bar-warning").addClass("progress-bar-danger"),t>=50&&e.removeClass("progress-bar-danger progress-bar-warning").addClass("progress-bar-success")},hasDeviceCode:function(){return"undefined"!=typeof kp.data.storage.device.code&&kp.data.storage.device.code?jQuery.now()/1e3>kp.data.storage.device.expire_in||this.deviceCodeExpiresIn()<=0?!1:(kp.log.add("Auth > hasDeviceCode > Через "+this.deviceCodeExpiresIn()+" секунд девайс токен умрет"),!0):!1},deviceCodeExpiresIn:function(){return parseInt(kp.data.storage.device.expires_in,10)-parseInt(jQuery.now()/1e3,10)},checkAccessToken:function(){return kp.log.add("Auth > checkAccessToken >  "+this.accessTokenExpiresIn()),this.hasAccessToken()?!0:void kp.api.updateAccessToken()},hasAccessToken:function(){return"undefined"!=typeof kp.data.storage.token.access_token&&kp.data.storage.token.access_token?jQuery.now()/1e3>kp.data.storage.token.expires_in||this.accessTokenExpiresIn()<=0?!1:!0:!1},accessTokenExpiresIn:function(){return parseInt(kp.data.storage.token.expires_in,10)-parseInt(jQuery.now()/1e3,10)}},kp.modules={onBoot:["data","device","ui","user","boot"],controlledBy:!1,_init:function(){for(moduleID in this.onBoot)this.load(this.onBoot[moduleID])},load:function(e){return"undefined"==typeof kp[e]?void kp.log.add("Modules > _init > Модуль не загружен "):(kp[e]._init(),void("undefined"!=typeof kp.log&&kp.log.add("Modules > _init > Загружен модуль "+e)))},transferControl:function(e,t){kp.log.add("Modules > Управление передано от "+this.controlledBy+" к "+e+"["+t+"]"),0!=this.controlledBy&&"undefined"!=typeof kp[this.controlledBy].onLostControl&&kp[this.controlledBy].onLostControl(),jQuery(document).off(),kp.device.keyHandlers={},kp.device.eventHandled={},kp.device.defaultControls(),this.controlledBy=e,0!=this.controlledBy&&"undefined"!=typeof kp[e].onGetControl&&kp[this.controlledBy].onGetControl("undefined"!=typeof t?t:!1),kp.device.setListeners()}},kp.lang.ru={device_default_name:"Мой TizenTV",device_default_webapp_name:"WebApp",device_default_webapp_detailed_name:"WebApp by ctepeo",device_activation_header:"Активация устройства",device_activation_description:"Введите указанный код на сайте"};